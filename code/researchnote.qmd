---
title: "researchnote"
format: html
editor: visual
---

```{r setup,include = FALSE,echo=FALSE}
set.seed(0506)
options (warn = -1)
setwd("/Users/zhumeng/Desktop/Spring semester_2023/leadership/code")
# packbirth loading
library(pacman)
p_load("rio",
       "here",
       "tidyverse",
       "countrycode",
       "car",
       "haven",
       "lubridate",
       "modelsummary")
```

# dataLoda



## data_leadership

```{r dataloda}
#arc_raw <- read_dta("../data/Archigos_4.1.dta") %>%
#  mutate(country = str_sub(obsid,1,3),
#         year = str_sub(obsid,5,8)) %>%
#   filter(.,year %in% c(1945:2015))
#write.csv(arc_raw,file = "../data/arc_raw.csv",row.names = FALSE)

arc <- read.csv("../data/arc.csv") %>%
  select(.,ccode,year,leadid,leader,gender,yrborn,yrdied,startdate,enddate,entry,exit,exitcode) %>%
  mutate(age = yrdied - yrborn) %>%
  filter(.,year >= 1945)
arc$year <- as.factor(arc$year)

#write.csv(arc,file = "../data/arc.csv",row.names = FALSE)
```

## data_ideologues

```{r}
ide <- read.csv("../data/Global_Leader_Ideologies_22_10_28/global_leader_ideologies.csv") %>%
  rename(countryname = country_name,
         ccode = country_code_cow) %>%
  select(.,ccode,year,leader,leader_position,leader_ideology,leader_ideology_num_redux,leader_party_eng,leader_party_abbr,region) %>%
  filter(.,year >= 1945) %>%
  complete(.,ccode,year)
ide$year <- as.factor(ide$year)

```

## data_vdem

```{r}
vdem <- readRDS("../data/Vdem/VDem_12_full.rds") %>%
  select(.,country_name,country_text_id,COWcode,year,v2x_polyarchy,v2x_liberal,v2exl_legitideol,v2exl_legitlead,v2exl_legitperf,v2exl_legitratio,v2cagenmob,v2cademmob,v2caautmob,v2smpolsoc,v2cacamps,v2x_civlib,v2svstterr,v2stfisccap,e_regionpol) %>%
  rename(countryname = country_name,
         countrycode = country_text_id,
         ccode = COWcode,
         dem_electoral = v2x_polyarchy,
         dem_liberal = v2x_liberal,
         leg_ideol = v2exl_legitideol,
         leg_leader = v2exl_legitlead,
         leg_perfermance = v2exl_legitperf,
         leg_legal = v2exl_legitratio,
         mob_mass = v2cagenmob,
         mob_demo = v2cademmob,
         mob_auto = v2caautmob,
         pol_society = v2smpolsoc,
         pol_political = v2cacamps,
         lib_civil = v2x_civlib,
         cap_territory = v2svstterr,
         cap_fiscal = v2stfisccap,
         regionpol = e_regionpol) %>%
  filter(.,year >= 1945)
vdem$year <- as.factor(vdem$year)

# ov and iv combine
maindata <- ide %>%
  left_join(.,arc,by = c("ccode","year","leader")) %>%
  left_join(.,vdem,by = c("ccode","year")) %>%
  select(.,-c(countryname,countrycode))

maindata$countryname <- countrycode(maindata$ccode,
                                   origin = "cown",
                                   destination = "country.name",
                                   custom_match = c(
                                     "260"= "Germany",
                                     #"340" = "Honduras",
                                     "711" = "Tibet")) #711是西藏 vdem和ide都没有340，arc有340
maindata$countrycode <- countrycode(maindata$ccode,
                                   origin = "cown",
                                   destination = "iso3c",
                                   custom_match = c(
                                     "260"= "DEU",
                                     "265" = "DDR",
                                     "315" = "CZE",
                                     "340" = "SER",
                                     "345" = "SRB",
                                     "347" = "XKX",	
                                     "511" = "ZZB",
                                     "678" = "YEM",
                                     "680" = "YMD",
                                     "817" = "VDR",
                                     "711" = "TBT"))
```

## data_cv

### cvLoda

```{r loda_cv}
# regimeType
#regime1 <- read_dta("../data/regimetpye/GWF_AllPoliticalRegimes.dta") %>%
#  select(.,cowcode,year,gwf_regimetype)
regime <- read_dta("../data/regimetpye/GWFtscs.dta") %>%
  select(.,cowcode,year,gwf_regimetype) %>%
  rename(ccode = cowcode,
         type = gwf_regimetype) 
regime$year <- as.factor(regime$year)
regime$countrycode <- countrycode(regime$ccode,
                                  origin = 'cown',
                                  destination = 'iso3c',
                                  custom_match = c(
                                     "265" = "DDR",
                                     "315" = "CZE",
                                     "345" = "SRB",
                                     "347" = "XKX",
                                     "678" = "YEM",
                                     "680" = "YMD",
                                     "817" = "VDR"))

regime <- regime %>%
   mutate(regimeType = case_when(
     type %in% c('party-personal','party-personal-military','party-military','party-based', 'oligarchy') ~ 1,
     type %in% c('personal') ~ 2,
     type %in% c('military','military-personal','indirect military') ~ 3,
     type %in% c('monarchy') ~ 4
   ))

# GDP data
## pwt gdpp
pwt <- read_dta("../data/pwt1001.dta") %>%
  select(.,countrycode,year,rgdpna,pop) %>%
  rename(pop_pwt = pop) %>%
  mutate(rgdppna = rgdpna/pop_pwt)
pwt$year <- as.factor(pwt$year)
## world bank
gdppg <- read.csv("../data/gdp_growth.csv",check.names=FALSE)  %>%
  reshape2::melt(.,
                 id.vars=c("countrycode","Country Name"),
                 variable.name = "year",
                 value.name = "gdppg" 
                 ) %>%
  select(.,-c(`Country Name`))

gdpp <- read.csv("../data/gdp (constant 2015 US$).csv",check.names=FALSE) %>%
  reshape2::melt(.,
                 id.vars=c("countrycode","Country Name"),
                 variable.name = "year",
                 value.name = "gdpp" 
                 ) %>%
  select(.,-c(`Country Name`))

#总人口
population <- read.csv("../data/pop.csv",check.names=FALSE) %>%
  reshape2::melt(.,
                 id.vars=c("countrycode","Country Name"),
                 variable.name = "year",
                 value.name = "pop" 
                 ) %>%
  mutate(popl = log(pop)) %>%
  select(.,-c(`Country Name`))
  
#石油占国家gdp
oil <- read.csv("../data/oil(% of GDP).csv",check.names=FALSE) %>%
  reshape2::melt(.,
                 id.vars=c("countrycode"),
                 variable.name = "year",
                 value.name = "oil" 
                 ) 
## religion

## inequality
load("../data/swiid9_4.rda")
swiid_summary$iso3c <- countrycode(swiid_summary$country, 
                                   origin = 'country.name',
                                   destination = 'iso3c',
                                   custom_match = c(
                                    "Czechoslovakia" = "CSK",
                                    "Kosovo" = "SRB",
                                    "Micronesia" = "FSM",
                                    "Yugoslavia" = "YUG"
                                   )) 

swiid_summary <- swiid_summary %>%
  select(.,iso3c,country,year,gini_disp,gini_mkt) %>%
  rename(gini_tax = gini_disp,
         countrycode = iso3c,
         countryname = country)
swiid_summary$year <- as.factor(swiid_summary$year)

## DPI data for policy
prsd <- haven::read_dta("../data/DPI2020/DPI2020.dta")
# Parliamentary (2), Assembly-elected President (1), Presidential (0)
prsd <- prsd %>% 
  select(.,ifs,year,system,yrsoffc,finittrm,yrcurnt,execrlc,execnat,polariz,termlimit) %>% 
  rename(parliamentary = system,
         countrycode = ifs) 
prsd$year <- as.factor(prsd$year)
## inflation
infla_consumerPrices <- read.csv("../data/consumerPrices.csv",check.names=FALSE) %>%
  reshape2::melt(.,
                 id.vars=c("countrycode"),
                 variable.name = "year",
                 value.name = "consumerPrices" 
                 ) 

infla_deflator <- read.csv("../data/inflation(wb).csv",check.names=FALSE) %>%
  reshape2::melt(.,
                 id.vars=c("countrycode"),
                 variable.name = "year",
                 value.name = "infla_deflator" 
                 )

inflation <- readRDS("../data/inflation.rds") %>%
   select(.,iso3c,year,FP.CPI.TOTL.ZG) %>%
   rename(inflation = FP.CPI.TOTL.ZG,
          countrycode = iso3c)
inflation$year <- as.factor(inflation$year)
```


# dataCombine

```{r fulldata}
fulldata <- maindata %>%
  left_join(.,regime,by = c("ccode","countrycode","year")) %>%
  left_join(.,pwt,by = c("countrycode","year")) %>%
  left_join(.,gdpp,by = c("countrycode","year")) %>%
  left_join(.,gdppg,by = c("countrycode","year")) %>%
  left_join(.,prsd,by = c("countrycode","year")) %>%
  left_join(.,population,by = c("countrycode","year")) %>%
  left_join(.,infla_consumerPrices, by = c("countrycode","year")) %>%
  left_join(.,infla_deflator, by = c("countrycode","year")) %>%
  left_join(.,inflation, by = c("countrycode","year")) %>%
  left_join(.,oil, by = c("countrycode","year")) %>%
  left_join(.,swiid_summary,by = c("countrycode","year","countryname"))

fulldata[fulldata < 0 ] <- NA
fulldata <- fulldata %>%
  group_by(countrycode) %>%
  mutate(dem_electoral_lag5 = lag(dem_electoral,5),
         dem_electoral_lag1 = lag(dem_electoral,1),
         dem_liberal_lag = lag(dem_liberal),
         rgdppna_lag = lag(rgdppna),
         gdpp_lag = lag(gdpp),
         gdppg_lag = lag(gdppg),
         gapp_lag_log = log(lag(gdpp)),
         infla_deflator_lag = lag(infla_deflator),
         consumerPrices_lag = lag(consumerPrices),
         inflation_lag = lag(inflation),
         gini_tax_lag = lag(gini_tax),
         gini_mkt_lag = lag(gini_mkt),
         ) %>%
  ungroup()

fulldata <- fulldata %>%
  select(ccode,countrycode,countryname,year,leader,gender,yrborn,yrdied,age,startdate,enddate,leader_position,leader_ideology,leader_ideology_num_redux,leader_party_eng,leader_party_abbr,entry,exit,exitcode,parliamentary,yrsoffc,finittrm,execrlc,execnat,termlimit,dem_electoral,dem_electoral_lag5,dem_electoral_lag1,dem_liberal,dem_liberal_lag,leg_ideol,leg_leader,leg_perfermance,leg_legal,mob_mass,mob_demo,mob_auto,pol_society,pol_political,lib_civil,cap_territory,cap_fiscal,type,regimeType,rgdpna,pop_pwt,rgdppna,rgdppna_lag,gdppg,gdppg_lag,gdpp,gdpp_lag,gapp_lag_log,pop,popl,infla_deflator,infla_deflator_lag,consumerPrices,consumerPrices_lag,inflation,inflation_lag,gini_tax,gini_mkt,gini_tax_lag,gini_mkt_lag,oil,regionpol,region) %>%
  filter(.,!(ccode %in% c("711","31","80","835")))

#rm(oil,gdpp,gdppg,infla_consumerPrices,infla_deflator,inflation,population,pwt,prsd,regime,swiid_summary,swiid)
```

# dataClean
### dataPre
```{r warning=FALSE}
fulldata <- fulldata %>%
  mutate(
    start_year = year(fulldata$startdate),
    end_year = year(fulldata$enddate),
    year_off = end_year - start_year) 

dem_country <- fulldata %>%
  select(.,ccode,countrycode,countryname,year,leader,dem_electoral,start_year,end_year) %>%
  group_by(ccode) %>%
  summarise(
    score_countrym = mean(dem_electoral,na.rm = TRUE)
  ) %>%
  ungroup

dem_lead <- fulldata %>%
  select(.,ccode,countrycode,countryname,year,leader,dem_electoral,start_year,end_year) %>%
  group_by(leader) %>%
  summarise(
    score_leaderm = mean(dem_electoral,na.rm = TRUE)
  ) %>%
  ungroup

dem_year <- fulldata %>%
  select(.,ccode,countrycode,countryname,year,leader,dem_electoral) %>%
  group_by(year) %>%
  summarise(
    score_yearm = mean(dem_electoral,na.rm = TRUE)
  ) %>%
  ungroup

dem_di <- fulldata %>%
  select(.,ccode,countrycode,countryname,year,leader,dem_electoral,start_year,end_year) %>% 
  mutate(end_year = end_year - 1) %>%
  group_by(countryname) %>% 
  arrange(year) %>% 
  mutate(diff_socre = ifelse(year == start_year, (lag(dem_electoral) - lead(dem_electoral)),NA_real_)) %>% 
  mutate(score_before = ifelse(year == start_year,(((lag(dem_electoral,default = 0) + lag(dem_electoral,2,default = 0)))/2),NA_real_)) %>%
  mutate(score_after = ifelse(year == end_year,(((dem_electoral + lag(dem_electoral,default = 0)))/2),NA_real_)) %>%
  ungroup() 

df_reduced <- dem_di %>%
  select(.,ccode,leader,start_year, score_before,score_after) %>%
  group_by(ccode,leader) %>%
  summarise(score_before = sum(score_before,na.rm = TRUE),
            score_after = sum(score_after,na.rm = TRUE)) %>%
  ungroup()

dem_di <- dem_di %>%
  select(.,-c(score_before,score_after))

dem_di <- dem_di %>% 
  left_join(.,df_reduced,by = c(
    "ccode" = "ccode",
    "leader" = "leader"
  )) %>%
  select(.,countrycode,year,leader,score_before,score_after)


fulldata <- fulldata %>%
  left_join(.,dem_country) %>%
  left_join(.,dem_lead) %>%
  left_join(.,dem_year) %>%
  left_join(.,dem_di,by = c("countrycode","year","leader")) %>%
  distinct()  
```

## dataAnalysis
```{r warning=FALSE}
fulldata$diff_year <- fulldata$dem_electoral - fulldata$score_yearm
fulldata$diff_electoral <-  fulldata$dem_electoral - fulldata$dem_electoral_lag5
fulldata$diff_electoral_rate <- fulldata$diff_electoral/ fulldata$dem_electoral_lag5
fulldata$diff_electoral_po <- fulldata$diff_electoral_rate
fulldata$diff_electoral_na <- fulldata$diff_electoral_rate
fulldata$diff_electoral_po <- Recode(fulldata$diff_electoral_po,"-9999:-0.0000001 = NA")
fulldata$diff_electoral_na <- Recode(fulldata$diff_electoral_na,"0:9999 = NA")
fulldata_rate <- fulldata %>%
  group_by(year) %>%
  summarise(electoral_rate_year = Mean(diff_electoral_rate,na.rm = TRUE)) %>%
  ungroup()
fulldata <- fulldata %>%
  left_join(.,fulldata_rate)
fulldata$diff_electoral_po <- fulldata$diff_electoral_po - fulldata$electoral_rate_year
fulldata$diff_electoral_na <- fulldata$diff_electoral_na - fulldata$electoral_rate_year
rm(fulldata_rate)

#fulldata <- fulldata %>%
#  mutate(diff_dummy_dem = if_else(diff_electoral >= 0.03,1,0),
#         diff_dummy_aut = if_else(diff_electoral < -0.03,1,0))
#fulldata$diff_elec_year <- fulldata$dem_electoral - fulldata$dem_electoral_lag - fulldata$score_yearm


#write.csv(fulldata_year,file = "../data/fulldata.csv",row.names = FALSE)
#fulldata <- fulldata %>%
#  filter(.,leader != "Truman")
fulldata_year <- fulldata %>%
  group_by(countrycode,leader) %>%
  summarize(year_offs = year_off) %>%
  filter(.,year_offs >= 3) %>%
  distinct()

fulldata <- fulldata_year %>%
  left_join(.,fulldata,by =c("countrycode","leader")) %>%
  distinct()
  
#write.csv(fulldata,file = "../data/fulldata.csv",row.names = FALSE)

```


# data for auth
```{r realdata}
fulldata <-fulldata %>%
  group_by(leader) %>%
  mutate(first_start = first(start_year,order_by = start_year)) %>%
  arrange(leader,start_year) %>%
  ungroup() 

fulldata <- fulldata %>%
  group_by(leader) %>%
  mutate(first_end = last(end_year,order_by = end_year) - 1) %>%
  arrange(leader,end_year) %>%
  ungroup() %>%
  mutate(turn_over = if_else(year == first_end,1,0))

fulldata_auth <- fulldata %>%
  group_by(leader,first_start) %>%
  mutate(auth = if_else(first(dem_electoral < 0.5),1,0)) %>%
  ungroup() %>%
  filter(.,auth == 1) 

fulldata_auth_1989a <- fulldata_auth %>%
  filter(.,year %in% c(1989:2020))

fulldata_auth_1989b <- fulldata_auth %>%
  filter(.,year %in% c(1945:1988))


#fulldata_dem <- fulldata %>%
#  group_by(leader,first_start) %>%
#  mutate(dem = if_else(first(dem_electoral >= 0.5),1,0)) %>% 
#  ungroup() %>%
#  filter(.,dem == 1)

worldleaders <- fulldata_auth %>%
  select(.,countrycode,year,leader,diff_electoral,auth) %>%
  rename(unit = countrycode,
         time = year,
         growth = diff_electoral) %>%
  unique() 

write_dta(worldleaders, "../replication/worldleaders.dta")
temp <- fulldata_auth %>%
  select(.,)
```

# regression
```{r}
lm_h1 <- lm(dem_electoral ~ as.factor(countrycode)+ as.factor(year),data = fulldata_auth)

res_h1 <- broom::augment(lm_h1) %>%
  select(.,`as.factor(countrycode)`,`as.factor(year)`,dem_electoral,.resid) %>%
  rename(res = .resid,
         countrycode = `as.factor(countrycode)`,
         year = `as.factor(year)`)

fulldata_auth <- fulldata_auth %>%
  left_join(.,res_h1,by = c("countrycode","year","dem_electoral")) %>%
  distinct()



```

# replicaition

```{r}
simdata <- fulldata
simdata$year_real <- year(ymd(simdata$year, truncated = 2))

worldleaders <- simdata %>%
  mutate(year_sim5a = year_real + 5,
         year_sim5b = year_real - 5) %>%
  select(.,countrycode,year_real,leader,score_country_year) %>%
  rename(unit = countrycode,
         time = year_real,
         growth = score_country_year) %>%
  mutate(all = 1) %>%
  unique()
  
worldleaders <- fulldata %>%
  select(.,countrycode,year,leader,diff_lead) %>%
  rename(unit = countrycode,
         time = year,
         growth = diff_lead) %>%
  mutate(all = 1) %>%
  unique()

```

# Endogenous test
```{r}
fulldata_auth$diff_electoral_rate <- fulldata_auth$diff_electoral/ fulldata_auth$dem_electoral_lag5
fulldata_auth$diff_electoral_rateN <- fulldata_auth$diff_electoral_rateN / fulldata_auth$dem_electoral_lag5
fulldata_auth$diff_electoral_rateP <- fulldata_auth$diff_electoral_rate
fulldata_auth$diff_electoral_rateN <- fulldata_auth$diff_electoral_rate
fulldata_auth$diff_electoral_rateP[fulldata_auth$diff_electoral_rateP < 0] <- NA
fulldata_auth$diff_electoral_rateN[fulldata_auth$diff_electoral_rateP >= 0] <- NA
fulldata_auth$diff_electoral_rateP_se <- scales::rescale(fulldata_auth$diff_electoral_rateP,to =c(0,1))
fulldata_auth$diff_electoral_rateN_se <- scales::rescale(fulldata_auth$diff_electoral_rateN,to =c(0,1))

temp <- fulldata_auth %>%
  select(.,ccode,countrycode,leader,dem_electoral,dem_electoral_lag5,diff_electoral,diff_electoral_rate,diff_electoral_rateP,diff_electoral_rateP_se,diff_electoral_rateN,diff_electoral_rateN_se)

lm_ctr <- lm(turn_over~ as.factor(year) + as.factor(countrycode),data = fulldata_auth)
lm_iv_po <- lm(turn_over~ as.factor(year) + as.factor(countrycode) + diff_electoral_rateP_se,data = fulldata_auth)
lm_iv_na <- lm(turn_over~ as.factor(year) + as.factor(countrycode) + diff_electoral_rateN_se,data = fulldata_auth)

msummary(list(lm_ctr,lm_iv_po,lm_iv_na),
         coef_omit = "as.factor*",
         output="../outputs/regression.docx",
         stars = TRUE)
```
